<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mastercard Click to Pay Integration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://sandbox.src.mastercard.com/srci/integration/2/lib.js?srcDpaId=4b03a667-6b18-467e-b046-e93c05e26176&locale=zh_HK"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Noto Sans TC"', "Inter", "sans-serif"],
            },
            colors: {
              visa: {
                blue: "#005bd3",
                bg: "#eff5ff",
                nav: "#fafafa",
                info: "#cfdbe5",
                border: "#e5e7eb",
                input: "#9b9b9b",
                text: "#141413",
              },
            },
            boxShadow: {
              form: "0px 25px 50px -12px rgba(0,0,0,0.25)",
              section: "0px 1px 2px -1px rgba(0,0,0,0.1)",
            },
            borderRadius: {
              "top-card": "12px",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Noto Sans TC", "Inter", sans-serif;
        background-color: #eff5ff;
        color: #000;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.2s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
      .toast-enter-active,
      .toast-leave-active {
        transition: all 0.3s ease;
      }
      .toast-enter-from,
      .toast-leave-to {
        opacity: 0;
        transform: translateY(-20px);
      }
      .toast-move {
        transition: transform 0.3s ease;
      }
    </style>
  </head>
  <body class="w-full min-h-screen flex justify-center bg-[#eff5ff]">
    <div id="app" class="w-full flex justify-center"></div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      const mcCheckoutService = new MastercardCheckoutServices();
      const { createApp, ref, computed, defineComponent, nextTick, onMounted } =
        Vue;

      // --- Common Components ---

      const NavigationBar = defineComponent({
        emits: ["close"],
        template: `
          <div class="bg-[#fafafa] flex items-center justify-between w-full px-2 py-1 shrink-0">
             <!-- Cancel Button -->
             <div class="flex items-center p-2 cursor-pointer" @click="$emit('close')">
                <span class="text-[#6a7282] text-base leading-6 font-normal font-sans">取消</span>
             </div>
             
             <!-- Language Label -->
             <div class="bg-white border border-[#e5e7eb] rounded-[6px] px-5 py-[7px] flex items-center gap-[9px] shrink-0">
                <span class="text-xs font-bold leading-[18px] text-[#000000de]">中文</span>
             </div>
          </div>
        `,
      });

      const HeaderTitle = defineComponent({
        props: ["text"],
        template: `
          <div class="bg-[#fafafa] flex flex-col items-start justify-center px-5 py-2 w-full shrink-0">
             <h1 class="text-[20px] font-bold leading-[30px] text-[#000000de]">{{ text }}</h1>
          </div>
        `,
      });

      const ActionButton = defineComponent({
        props: {
          primary: Boolean,
          text: String,
          disabled: Boolean,
        },
        template: `
            <button 
                class="flex items-center justify-center px-[16px] py-[10px] rounded-[6px] w-full shrink-0 transition"
                :class="[
                    primary 
                        ? 'bg-[#005bd3] text-white hover:bg-[#004dc1]' 
                        : 'bg-white border-2 border-[#005bd3] text-[#005bd3] hover:bg-blue-50',
                    disabled ? 'opacity-50 cursor-not-allowed' : ''
                ]"
                :disabled="disabled"
            >
                <slot name="icon"></slot>
                <span class="text-[16px] leading-[24px] font-semibold font-sans whitespace-nowrap">{{ text }}</span>
            </button>
        `,
      });

      const OrDivider = defineComponent({
        template: `
            <div class="relative flex items-center justify-center h-[40px] w-full shrink-0">
                <div class="w-full border-t border-[#d1d5dc]"></div>
                <div class="absolute bg-white px-3 text-[#6a7282] text-[14px] leading-[20px] font-normal font-sans">
                    OR
                </div>
            </div>
        `,
      });

      const LoadingOverlay = defineComponent({
        props: {
          text: { type: String, default: "處理中" },
          subtext: { type: String, default: "" },
        },
        template: `
          <div class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white bg-opacity-60">
            <div class="w-[200px] h-[200px] mb-6 border-4 border-gray-100 rounded-full animate-spin border-t-[#005bd3]"></div>
            <div class="mb-1 font-semibold text-[#141413]">{{ text }}</div>
            <div v-if="subtext" class="text-sm text-[#666]">{{ subtext }}</div>
          </div>
        `,
      });

      const Toast = defineComponent({
        props: ["toasts"],
        template: `
          <div class="fixed top-10 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-3 items-center pointer-events-none">
            <transition-group name="toast">
              <div v-for="toast in toasts" :key="toast.id" 
                   class="px-6 py-3 rounded-full shadow-lg text-white font-medium flex items-center gap-2 pointer-events-auto"
                   :class="toast.type === 'error' ? 'bg-red-500' : 'bg-green-500'">
                  <div v-if="toast.type === 'error'" class="w-5 h-5">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  </div>
                  <div v-else class="w-5 h-5">
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  {{ toast.message }}
              </div>
            </transition-group>
          </div>
        `,
      });

      // --- Login Step Components ---

      const TabGroup = defineComponent({
        props: ["modelValue"],
        emits: ["update:modelValue"],
        template: `
          <div class="flex items-center justify-center w-full pt-3 shrink-0">
             <div class="flex-1 flex flex-col items-center cursor-pointer relative" @click="$emit('update:modelValue', 'email')">
                <div class="w-full flex justify-center px-[12px] py-[14px] rounded-tl-[6px]" :class="modelValue === 'email' ? 'bg-[#eff5ff]' : 'bg-[#fafafa]'">
                    <span class="text-[14px] leading-[20px]" :class="modelValue === 'email' ? 'text-[#000000de] font-normal' : 'text-[#2f7cf5] font-normal'">電子信箱</span>
                </div>
                <div class="h-[2px] w-full" :class="modelValue === 'email' ? 'bg-[#005bd3]' : 'bg-transparent'"></div>
             </div>
             <div class="flex-1 flex flex-col items-center cursor-pointer relative" @click="$emit('update:modelValue', 'phone')">
                <div class="w-full flex justify-center px-[12px] py-[14px] rounded-tr-[6px]" :class="modelValue === 'phone' ? 'bg-[#eff5ff]' : 'bg-[#fafafa]'">
                    <span class="text-[14px] leading-[20px]" :class="modelValue === 'phone' ? 'text-[#000000de] font-normal' : 'text-[#2f7cf5] font-normal'">手機</span>
                </div>
                <div class="h-[2px] w-full" :class="modelValue === 'phone' ? 'bg-[#005bd3]' : 'bg-transparent'"></div>
             </div>
          </div>
        `,
      });

      const InputField = defineComponent({
        props: {
          label: String,
          modelValue: String,
          icon: String,
          hasIconBg: Boolean,
          rule: { type: String, default: "" }, // options: 'card', 'expiry', 'cvc'
        },
        emits: ["update:modelValue"],
        inheritAttrs: false,
        setup(props, { emit }) {
          const handleInput = (event) => {
            let val = event.target.value;

            if (props.rule === "card") {
              val = val.replace(/\D/g, "").substring(0, 16);
              val = val.replace(/(\d{4})(?=\d)/g, "$1 ");
            } else if (props.rule === "expiry") {
              val = val.replace(/\D/g, "").substring(0, 4);
              if (val.length >= 2) {
                val = val.substring(0, 2) + "/" + val.substring(2);
              }
            } else if (props.rule === "cvc") {
              val = val.replace(/\D/g, "").substring(0, 3);
            }

            emit("update:modelValue", val);
          };
          return { handleInput };
        },
        template: `
            <div class="flex flex-col gap-[5px] w-full h-[52px] items-start relative shrink-0">
                <div class="bg-white border border-[#9b9b9b] rounded-[8px] flex items-start w-full relative focus-within:ring-1 focus-within:ring-[#005bd3] focus-within:border-[#005bd3] overflow-hidden">
                    <div v-if="icon" class="flex items-center h-[52px] pl-[11px] pr-0 py-0 shrink-0" :class="hasIconBg ? '' : 'opacity-20'">
                        <div class="shrink-0" :class="hasIconBg ? 'w-[32px] h-[21px] bg-gray-100 rounded overflow-hidden' : 'w-[32px] h-[28px]'">
                             <img v-if="icon === 'email'" src="./public/ic_email.svg" class="w-full h-full" draggable="false">
                             <img v-if="icon === 'phone'" src="./public/ic_phone.svg" class="w-full h-full" draggable="false">
                             <img v-if="icon === 'card'" src="public/ic_card.svg" class="w-full h-full object-contain" draggable="false">
                        </div>
                    </div>
                    <div class="flex-1 h-[52px] relative shrink-0">
                         <input 
                            v-bind="$attrs"
                            class="w-full h-full border-none outline-none text-[16px] text-[#141413] pt-[16px] px-[11px] bg-transparent peer z-10 relative font-sans placeholder-transparent focus:ring-0"
                            :value="modelValue" 
                            @input="handleInput" 
                            placeholder=" " 
                         />
                          <label class="absolute left-[11px] text-[#0000008a] transition-all duration-200 pointer-events-none font-sans
                                   peer-placeholder-shown:text-[14px] peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 
                                   peer-focus:text-[12px] peer-focus:top-[0px] peer-focus:translate-y-0 peer-focus:text-[#005bd3]
                                   peer-[&:not(:placeholder-shown)]:text-[12px] peer-[&:not(:placeholder-shown)]:top-[0px] peer-[&:not(:placeholder-shown)]:translate-y-0">
                                {{ label }}
                         </label>
                    </div>
                </div>
            </div>
        `,
      });

      const LoginInfoBox = defineComponent({
        template: `
            <div class="bg-[#cfdbe5] flex items-start px-[20px] py-[12px] rounded-bl-[8px] rounded-br-[8px] w-full shrink-0">
                <p class="flex-1 text-[12px] leading-[18px] text-[rgba(0,0,0,0.6)] font-normal font-sans">Click to Pay 如何使用我的資訊？</p>
                <div class="w-[18px] h-[18px] shrink-0 ml-2">
                    <img src="/public/ic_infor.svg" class="w-full h-full">
                </div>
            </div>
        `,
      });

      const LoginStep = defineComponent({
        components: {
          NavigationBar,
          HeaderTitle,
          TabGroup,
          InputField,
          LoginInfoBox,
          ActionButton,
          OrDivider,
        },
        emits: ["next"],
        setup(props, { emit }) {
          const currentTab = ref("email");
          const emailValue = ref("someuser@example.com");
          const phoneValue = ref("");
          const isValid = computed(() => {
            if (currentTab.value === "email")
              return emailValue.value.length > 3;
            return phoneValue.value.length > 8;
          });

          const handleNext = () => {
            const payload = {
              type: currentTab.value,
              value:
                currentTab.value === "email"
                  ? emailValue.value
                  : phoneValue.value,
            };
            emit("next", payload);
          };

          return { currentTab, emailValue, phoneValue, isValid, handleNext };
        },
        template: `
            <div class="w-full flex justify-center bg-[#eff5ff] pt-[52px]">
                <div class="flex flex-col items-center w-full max-w-[603px]">
                    <div class="w-full flex flex-col bg-white rounded-t-[12px] overflow-hidden shadow-section">
                        <navigation-bar></navigation-bar>
                        <header-title text="歡迎使用 Click to Pay"></header-title>
                        <div class="bg-white flex flex-col pb-[20px] px-[20px] w-full shadow-section rounded-[5px] z-10">
                            <tab-group v-model="currentTab"></tab-group>
                            <div class="flex flex-col px-[20px] py-[12px] bg-[#eff5ff] w-full">
                                <div class="mb-[12px] flex justify-center text-center">
                                    <p class="text-[14px] leading-[20px] font-semibold text-[#000000de]">輸入新的電子信箱或手機號碼，即可存取另一組關聯的卡片</p>
                                </div>
                                <input-field v-if="currentTab === 'email'" label="電子信箱" v-model="emailValue" icon="email"></input-field>
                                <input-field v-else label="+886" v-model="phoneValue" icon="phone"></input-field>
                            </div>
                            <login-info-box></login-info-box>
                        </div>
                    </div>
                    <div class="w-full bg-white flex flex-col p-[20px] shadow-form rounded-b-[12px] z-0">
                        <action-button :primary="true" text="登入帳號" :disabled="!isValid" @click="handleNext"></action-button>
                        <or-divider></or-divider>
                        <action-button :primary="false" text="手動輸入卡片"></action-button>
                    </div>
                </div>
            </div>
        `,
      });

      // --- OTP Step Components ---

      const OtpInput = defineComponent({
        props: ["modelValue"],
        emits: ["update:modelValue"],
        setup(props, { emit }) {
          const values = ref(
            props.modelValue && props.modelValue.length === 6
              ? props.modelValue.split("")
              : Array(6).fill("")
          );

          const handleInput = (index, event) => {
            const val = event.target.value;
            if (!/^[0-9]*$/.test(val)) {
              event.target.value = values.value[index];
              return;
            }

            if (val.length > 0) {
              values.value[index] = val.slice(-1);
              if (index < 5) {
                const nextInput = document.getElementById(`otp-${index + 1}`);
                if (nextInput) nextInput.focus();
              }
            } else {
              values.value[index] = "";
            }
            emit("update:modelValue", values.value.join(""));
          };

          const handleKeydown = (index, event) => {
            if (
              event.key === "Backspace" &&
              !values.value[index] &&
              index > 0
            ) {
              const prevInput = document.getElementById(`otp-${index - 1}`);
              if (prevInput) prevInput.focus();
            }
          };

          return { values, handleInput, handleKeydown };
        },
        template: `
            <div class="flex items-center justify-center gap-2">
                <template v-for="(v, i) in values" :key="i">
                    <div class="w-[48px] h-[56px] bg-white border-2 border-[#e6e6e6] rounded-[5px] flex items-center justify-center overflow-hidden focus-within:border-[#005bd3]">
                        <input 
                            :id="'otp-' + i"
                            type="text" 
                            inputmode="numeric" 
                            class="w-full h-full text-center text-[20px] font-bold border-none p-0 focus:ring-0" 
                            :value="values[i]"
                            maxlength="1"
                            @input="handleInput(i, $event)"
                            @keydown="handleKeydown(i, $event)"
                        />
                    </div>
                </template>
            </div>
        `,
      });

      const CheckboxField = defineComponent({
        props: ["modelValue", "label"],
        emits: ["update:modelValue"],
        template: `
            <div class="flex items-center p-3 cursor-pointer" @click="$emit('update:modelValue', !modelValue)">
                <div class="flex items-start p-2 rounded-[4px]">
                    <div class="w-[18px] h-[18px] bg-white border-2 border-[#005bd3] rounded-[2px] flex items-center justify-center">
                         <svg v-if="modelValue" class="w-3 h-3 text-[#005bd3] fill-current" viewBox="0 0 20 20">
                             <path d="M0 11l2-2 5 5L18 3l2 2L7 18z"/>
                         </svg>
                    </div>
                </div>
                <div class="flex gap-2 flex-1 ml-[11px] text-[16px] leading-[24px] font-semibold text-[#000000de] font-sans user-select-none">
                    <slot name="icon"></slot> <span>{{ label }}</span>
                </div>
            </div>
        `,
      });

      const OtpInfoBox = defineComponent({
        template: `
          <div class="w-full bg-[#cfdbe5] rounded-b-[8px] px-[20px] py-[12px]">
             <p class="text-[12px] leading-[18px] text-[rgba(0,0,0,0.6)] font-normal font-sans mb-[1px]">
               如果系統記住了您的訊息，下次您無需輸入代碼即可安全存取已儲存的銀行卡。
             </p>
             <p class="text-[12px] leading-[18px] text-[rgba(0,0,0,0.6)] font-normal font-sans">
               因為使用 Cookie，不建議在公共或共用裝置上使用。
             </p>
          </div>
        `,
      });

      const OtpStep = defineComponent({
        components: {
          NavigationBar,
          HeaderTitle,
          OtpInput,
          CheckboxField,
          OtpInfoBox,
          ActionButton,
          OrDivider,
        },
        props: ["otpDestination"],
        emits: ["next"],
        setup(props, { emit }) {
          const otpCode = ref("");
          const rememberMe = ref(false);

          const isValid = computed(() => otpCode.value.length === 6);

          const handleNext = () => {
            emit("next", otpCode.value);
          };

          return { otpCode, rememberMe, isValid, handleNext };
        },
        template: `
            <div class="w-full flex justify-center bg-[#eff5ff] pt-[52px]">
                <div class="flex flex-col items-center w-full max-w-[603px]">
                    <div class="w-full flex flex-col bg-white rounded-t-[12px] overflow-hidden shadow-section">
                        <navigation-bar></navigation-bar>
                        <header-title text="歡迎使用 Click to Pay"></header-title>
                        <div class="bg-white flex flex-col pb-[20px] px-[20px] w-full shadow-section rounded-[5px] z-10 pt-[20px]">
                            <div class="flex items-center justify-between w-full gap-[6px] mb-2">
                                <span class="text-[14px] leading-[1.5] text-[#141413] font-sans">{{ otpDestination }}</span>
                                <span class="text-[14px] leading-[1.5] text-[#005bd3] underline cursor-pointer font-sans">以其他帳戶登入</span>
                            </div>
                             <div class="flex flex-col w-full">
                                <div class="mb-[20px]">
                                    <h1 class="text-[16px] leading-[24px]">
                                        <span class="font-semibold font-sans">Click to Pay</span>
                                        <span class="font-semibold font-sans"> 已找到你的關聯卡</span>
                                    </h1>
                                </div>
                                <div class="mb-[16px]">
                                    <p class="text-[14px] leading-[20px] text-[#141413] font-normal font-sans">
                                        輸入 Mastercard 發送至 {{ otpDestination }} 的驗證碼以確認是您本人。
                                    </p>
                                </div>
                                <div class="flex flex-col w-full mb-[8px]">
                                    <otp-input v-model="otpCode"></otp-input>
                                </div>
                                <div class="flex items-center justify-center gap-[10px] mt-[25px] mb-[36px]">
                                    <span class="text-[14px] text-[#6a7282] font-normal font-sans">重新發送驗證碼：</span>
                                    <div class="flex items-center">
                                        <span class="text-[14px] text-[#005bd3] cursor-pointer font-sans pr-[12px]">手機簡訊</span>
                                        <div class="w-[1px] h-[24px] bg-[#e6e6e6]"></div>
                                        <span class="text-[14px] text-[#005bd3] cursor-pointer font-sans pl-[12px]">電子信箱</span>
                                    </div>
                                </div>
                                <div class="w-full">
                                    <div class="bg-[#f5f5f5] rounded-t-[8px] border-b border-transparent">
                                        <checkbox-field v-model="rememberMe" label="在這個瀏覽器儲存我的資料"></checkbox-field>
                                    </div>
                                    <div class="w-full bg-[#cfdbe5] rounded-b-[8px] px-[20px] py-[12px]">
                                      <p class="text-[12px] leading-[18px] text-[rgba(0,0,0,0.6)] font-normal font-sans mb-[1px]">
                                        如果系統記住了您的訊息，下次您無需輸入代碼即可安全存取已儲存的銀行卡。
                                      </p>
                                      <p class="text-[12px] leading-[18px] text-[rgba(0,0,0,0.6)] font-normal font-sans">
                                        因為使用 Cookie，不建議在公共或共用裝置上使用。
                                      </p>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                    <div class="w-full bg-white flex flex-col p-[20px] shadow-form rounded-b-[12px] z-0">
                        <action-button :primary="true" text="送出驗證碼" :disabled="!isValid" @click="handleNext"></action-button>
                        <or-divider></or-divider>
                        <action-button :primary="false" text="手動輸入卡片"></action-button>
                    </div>
                </div>
            </div>
        `,
      });

      // --- Select Card Components ---

      const CardOption = defineComponent({
        props: {
          card: { type: Object, required: true },
          selected: { type: Boolean, default: false },
        },
        emits: ["select"],
        template: `
          <div 
            @click="$emit('select', card.srcDigitalCardId)"
            class="w-full flex flex-col items-start px-[20px] py-[12px] border-solid rounded-[8px] cursor-pointer transition-colors"
            :class="selected ? 'border-2 border-[#e5e7eb] bg-[#f5f5f5]' : 'border border-[#d1d5dc] bg-white'"
          >
             <div class="flex items-center gap-[10px] w-full">
                <div class="relative w-[24px] h-[24px] shrink-0">
                    <div v-if="selected" class="w-[24px] h-[24px] rounded-full border-[6px] border-white bg-[#005bd3] shadow-sm flex items-center justify-center ring-1 ring-[#005bd3]"></div>
                    <div v-else class="w-[20px] h-[20px] rounded-full border border-[#767676] bg-white m-[2px]"></div>
                </div>
                <div class="flex items-center gap-[12px] h-[48px] flex-1">
                     <div class="w-[48px] h-[32px] rounded-[4px] shrink-0" style="background: linear-gradient(146.31deg, rgb(0, 187, 167) 0%, rgb(0, 150, 137) 100%);"></div>
                     <div class="flex flex-col flex-1 h-full justify-center">
                        <span class="text-[16px] text-[#101828] font-sans leading-[24px]">{{ card.bankName || 'Mastercard' }}</span>
                        <div class="flex items-center gap-[8px]">
                            <div class="w-[38px] h-[24px] relative bg-gray-100/50 rounded flex items-center justify-center">
                                <img :src="card.image || 'public/ic_c2p-card.svg'" class="h-[16px] w-auto" />
                            </div>
                            <span class="text-[16px] text-[#4a5565] font-sans">···· {{ card.last4 || card.panLastFour || '****' }}</span>
                        </div>
                     </div>
                </div>
             </div>
          </div>
        `,
      });

      const ManualEntryOption = defineComponent({
        components: { InputField, CheckboxField },
        props: {
          selected: { type: Boolean, default: false },
          cardNumber: String,
          expiry: String,
          cvc: String,
          rememberMe: Boolean,
        },
        emits: [
          "select",
          "update:cardNumber",
          "update:expiry",
          "update:cvc",
          "update:rememberMe",
        ],
        template: `
          <div 
            @click="$emit('select')"
            class="flex flex-col items-start px-[20px] py-[12px] border-solid rounded-[8px] w-full cursor-pointer transition-colors"
            :class="selected ? 'bg-[#f5f5f5] border-2 border-[#e5e7eb]' : 'bg-white border border-[#d1d5dc]'"
          >
             <div class="flex items-center gap-[10px] w-full mb-2">
                <div class="relative w-[24px] h-[24px] shrink-0">
                     <div v-if="!selected" class="w-[20px] h-[20px] rounded-full border border-[#767676] bg-white m-[2px]"></div>
                     <div v-else class="w-[24px] h-[24px] rounded-full border-[6px] border-white bg-[#005bd3] shadow-sm flex items-center justify-center ring-1 ring-[#005bd3]"></div>
                </div>
                <span class="text-[16px] text-[#4a5565] font-sans leading-[24px]">手動輸入卡片</span>
            </div>
            <div v-if="selected" class="w-full flex flex-col gap-[16px] px-0 py-[8px]">
                 <input-field 
                    label="輸入卡面號碼" 
                    :model-value="cardNumber"
                    @update:model-value="$emit('update:cardNumber', $event)"
                    icon="card" 
                    :has-icon-bg="true"
                    maxlength="19"
                    rule="card"
                 ></input-field>
                 <div class="flex gap-[14px] w-full">
                     <div class="flex-1">
                        <input-field 
                            label="效期 (MM/YY)" 
                            :model-value="expiry"
                            @update:model-value="$emit('update:expiry', $event)"
                            maxlength="5"
                            rule="expiry"
                        ></input-field>
                     </div>
                     <div class="flex-1">
                        <input-field 
                            label="安全碼" 
                            :model-value="cvc"
                            @update:model-value="$emit('update:cvc', $event)"
                            maxlength="3"
                            inputmode="numeric"
                            rule="cvc"
                        ></input-field>
                     </div>
                 </div>
                 <div class="w-full mt-2">
                    <checkbox-field 
                        :model-value="rememberMe" 
                        @update:model-value="$emit('update:rememberMe', $event)"
                        label="將此卡片與 Click to Pay 連結"
                    >
                        <template #icon>
                            <img src="public/ic_click-to-pay.svg" class="object-contain mr-2" />
                        </template>
                    </checkbox-field>
                 </div>
            </div>
          </div>
        `,
      });

      const SelectCardStep = defineComponent({
        components: {
          NavigationBar,
          HeaderTitle,
          ActionButton,
          CardOption,
          ManualEntryOption,
        },
        props: ["cards"],
        emits: ["pay", "cancel"],
        setup(props, { emit }) {
          const selectedOption = ref("manual");
          const userPhone = "+882 9·····234";

          const manualCard = ref({
            cardNumber: "",
            expiry: "",
            cvc: "",
            rememberMe: true,
          });

          const isExpanded = ref(false);
          const visibleCards = computed(() => {
            const list = props.cards || [];
            if (!list.length) return [];
            return isExpanded.value ? list : [list[0]];
          });
          const toggleExpand = () => {
            isExpanded.value = !isExpanded.value;
          };

          const handlePay = () => {
            let selectedSrcDigitalCardId = null;
            if (selectedOption.value !== "manual") {
              const card = props.cards.find(
                (c) => c.srcDigitalCardId === selectedOption.value
              );
              if (card) {
                selectedSrcDigitalCardId = card.srcDigitalCardId;
              }
            }
            // Emit event to parent to handle payment
            emit("pay", {
              srcDigitalCardId: selectedSrcDigitalCardId,
              isManual: selectedOption.value === "manual",
              ...manualCard.value,
            });
          };

          return {
            selectedOption,
            userPhone,
            manualCard,
            handlePay,
            visibleCards,
            isExpanded,
            toggleExpand,
          };
        },
        template: `
            <div class="w-full flex justify-center bg-[#eff5ff] min-h-screen pt-[52px] pb-[50px]">
                <div class="flex flex-col items-center w-full max-w-[603px]">
                    <div class="w-full flex flex-col bg-white rounded-t-[12px] overflow-hidden shadow-section">
                        <div class="w-full bg-[#fafafa] flex items-center justify-between px-[20px] py-[4px] border-b border-transparent">
                             <div class="p-[8px] cursor-pointer" @click="$emit('cancel')">
                                 <span class="text-[16px] text-[#6a7282] font-sans">取消</span>
                             </div>
                             <div class="flex items-center gap-[9px] bg-white border border-[#e5e7eb] rounded-[6px] px-[20px] py-[7px]">
                                 <span class="text-[12px] font-bold text-[rgba(0,0,0,0.87)] font-sans">中文</span>
                             </div>
                        </div>
                        <div class="w-full bg-[#fafafa] px-[20px] py-[5px]">
                            <h2 class="text-[20px] font-bold text-[rgba(0,0,0,0.87)] font-sans leading-[30px]">歡迎使用 Click to Pay</h2>
                        </div>
                        <div class="bg-white flex flex-col pb-[20px] px-[20px] w-full shadow-[0px_1px_2px_-1px_rgba(0,0,0,0.1)] z-10 pt-[0px]">
                            <div class="flex items-center gap-[8px] py-[12px]">
                                <img src="public/ic_c2p-card.svg" class="w-[46px] h-[28px]" />
                                <span class="text-[16px] font-semibold text-[rgba(0,0,0,0.6)] font-sans">信用卡</span>
                            </div>
                            <div class="flex items-center justify-between py-[12px] px-[8px]">
                                <span class="text-[16px] text-[#4a5565] font-sans">{{ userPhone }}</span>
                                <span class="text-[16px] text-[#005bd3] cursor-pointer font-sans py-[8px]">切換帳號</span>
                            </div>
                            <div class="flex flex-col gap-[20px]">
                                <div class="flex flex-col gap-[12px]">
                                    <card-option 
                                      v-for="card in visibleCards"
                                      :key="card.srcDigitalCardId"
                                      :card="card" 
                                      :selected="selectedOption === card.srcDigitalCardId"
                                      @select="selectedOption = card.srcDigitalCardId"
                                    ></card-option>
                                </div>
                                <div 
                                    v-if="cards.length > 1"
                                    class="w-full flex pt-[4px]"
                                >
                                     <span 
                                        @click="toggleExpand"
                                        class="text-[14px] text-[#005bd3] underline cursor-pointer font-sans leading-[20px] hover:text-[#00449e]"
                                     >
                                        {{ isExpanded ? '顯示較少' : \`顯示更多卡片 (+\${cards.length - 1})\` }}
                                     </span>
                                </div>
                                <div class="h-[10px] w-full"></div>
                                <manual-entry-option 
                                  :selected="selectedOption === 'manual'"
                                  v-model:cardNumber="manualCard.cardNumber"
                                  v-model:expiry="manualCard.expiry"
                                  v-model:cvc="manualCard.cvc"
                                  v-model:rememberMe="manualCard.rememberMe"
                                  @select="selectedOption = 'manual'"
                                ></manual-entry-option>
                            </div>
                        </div>
                    </div>
                    <div class="w-full bg-white flex flex-col p-[20px] shadow-[0px_25px_50px_-12px_rgba(0,0,0,0.25)] rounded-b-[12px] z-0">
                        <button 
                            class="w-full flex items-center justify-center gap-[6px] bg-[#005bd3] rounded-[6px] py-[10px] hover:bg-[#00449e] transition-colors"
                            @click="handlePay"
                        >
                            <img src="public/ic_lock.svg" class="w-[21px] h-[20px]" />
                            <span class="text-[16px] font-semibold text-white font-sans">支付 500 NTD</span>
                        </button>
                    </div>
                </div>
            </div>
            `,
      });

      // --- Register Components ---
      const RegisterStep = defineComponent({
        components: {
          NavigationBar,
          HeaderTitle,
          ActionButton,
          InputField,
          OrDivider,
          LoginInfoBox,
          CheckboxField,
        },
        emits: ["next", "prev"],
        setup(props, { emit }) {
          const cardNumber = ref("");
          const expiry = ref("");
          const cvc = ref("");
          const rememberMe = ref(true);

          const isValid = computed(() => {
            const rawCard = cardNumber.value.replace(/\D/g, "");
            const hasCard = rawCard.length >= 13 && rawCard.length <= 19;
            const hasExpiry = /^\d{2}\/\d{2}$/.test(expiry.value);
            const rawCvc = cvc.value.replace(/\D/g, "");
            const hasCvc = rawCvc.length >= 3 && rawCvc.length <= 4;
            return hasCard && hasExpiry && hasCvc;
          });

          const handleNext = () => {
            emit("next", {
              cardNumber: cardNumber.value,
              expiry: expiry.value,
              cvc: cvc.value,
              rememberMe: rememberMe.value,
            });
          };

          return {
            cardNumber,
            expiry,
            cvc,
            rememberMe,
            isValid,
            handleNext,
          };
        },
        template: `
            <div class="w-full flex justify-center bg-[#eff5ff] min-h-screen pt-[52px] pb-[50px]">
                <div class="flex flex-col items-center w-full max-w-[603px]">
                    <div class="w-full flex flex-col bg-white rounded-t-[12px] overflow-hidden shadow-section">
                        <div class="w-full bg-[#fafafa] flex items-center justify-between px-[20px] py-[4px] border-b border-transparent">
                             <div class="p-[8px] cursor-pointer" @click="$emit('prev')">
                                 <span class="text-[16px] text-[#6a7282] font-sans">取消</span>
                             </div>
                             <div class="flex items-center gap-[9px] bg-white border border-[#e5e7eb] rounded-[6px] px-[20px] py-[7px]">
                                 <span class="text-[12px] font-bold text-[rgba(0,0,0,0.87)] font-sans">中文</span>
                             </div>
                        </div>
                        <div class="w-full bg-[#fafafa] px-[20px] py-[5px]">
                            <h2 class="text-[20px] font-bold text-[rgba(0,0,0,0.87)] font-sans leading-[30px]">歡迎使用 Click to Pay</h2>
                        </div>
                        <div class="bg-white flex flex-col px-[40px] pt-[20px] pb-[40px] w-full z-10 shadow-[0px_1px_2px_-1px_rgba(0,0,0,0.1)]">
                             <p class="text-[12px] text-[#aaa] mb-[24px] font-sans">
                                未找到 a········r@example.com 的關聯卡片。請手動新增卡片與 Click to Pay 連結。
                             </p>
                             <div class="flex flex-col gap-[20px]">
                                <div class="flex gap-[16px]">
                                    <input-field 
                                        label="輸入卡面號碼" 
                                        v-model="cardNumber" 
                                        icon="card" 
                                        :has-icon-bg="true"
                                        maxlength="19"
                                        rule="card"
                                    ></input-field>
                                </div>
                                <div class="flex gap-[8px]">
                                    <div class="flex-1">
                                        <input-field 
                                            label="效期 (MM/YY)" 
                                            v-model="expiry" 
                                            maxlength="5"
                                            rule="expiry"
                                        ></input-field>
                                    </div>
                                    <div class="flex-1">
                                        <input-field 
                                            label="安全碼" 
                                            v-model="cvc" 
                                            maxlength="3"
                                            inputmode="numeric"
                                            rule="cvc"
                                        ></input-field>
                                    </div>
                                </div>
                             </div>
                             <div class="w-full mt-6">
                                 <div class="bg-[#f5f5f5] rounded-t-[8px] border-b border-transparent">
                                     <checkbox-field v-model="rememberMe" label="將此卡片與 Click to Pay 連結">
                                        <template #icon>
                                            <img src="public/ic_click-to-pay.svg" class="object-contain mr-2" />
                                        </template>
                                      </checkbox-field>
                                 </div>
                                 <div class="w-full bg-[#cfdbe5] rounded-b-[8px] px-[20px] py-[12px]">
                                  <p class="text-[12px] leading-[18px] text-[rgba(0,0,0,0.6)] font-normal font-sans mb-[1px]">
                                    如果系統記住了您的訊息，下次您無需輸入代碼即可安全存取已儲存的銀行卡。
                                  </p>
                                  <p class="text-[12px] leading-[18px] text-[rgba(0,0,0,0.6)] font-normal font-sans">
                                    因為使用 Cookie，不建議在公共或共用裝置上使用。
                                  </p>
                                </div>
                             </div>
                        </div>
                    </div>
                    <div class="w-full bg-white flex flex-col p-[20px] shadow-[0px_25px_50px_-12px_rgba(0,0,0,0.25)] rounded-b-[12px] z-0">
                       <action-button 
                           text="支付 500 NTD" 
                           :primary="true" 
                           :disabled="!isValid" 
                           @click="handleNext"
                       >
                        <template #icon>
                            <img src="public/ic_lock.svg" class="w-[21px] h-[20px]" />
                        </template>
                       </action-button>
                    </div>
                </div>
            </div>
        `,
      });

      const SuccessStep = defineComponent({
        components: { NavigationBar, HeaderTitle, ActionButton },
        emits: ["done"],
        template: `
            <div class="w-full flex justify-center bg-[#eff5ff] min-h-screen pt-[52px] pb-[50px]">
                <div class="flex flex-col items-center w-full max-w-[603px]">
                    <div class="w-full flex flex-col bg-white rounded-t-[12px] overflow-hidden shadow-section">
                        <div class="w-full bg-[#fafafa] flex items-center justify-between px-[20px] py-[4px] border-b border-transparent">
                             <div class="p-[8px] cursor-pointer" @click="$emit('done')">
                                 <span class="text-[16px] text-[#6a7282] font-sans">完成</span>
                             </div>
                             <div class="flex items-center gap-[9px] bg-white border border-[#e5e7eb] rounded-[6px] px-[20px] py-[7px]">
                                 <span class="text-[12px] font-bold text-[rgba(0,0,0,0.87)] font-sans">中文</span>
                             </div>
                        </div>
                        <div class="w-full bg-[#fafafa] px-[20px] py-[5px]">
                            <h2 class="text-[20px] font-bold text-[rgba(0,0,0,0.87)] font-sans leading-[30px]">歡迎使用 Click to Pay</h2>
                        </div>
                        <div class="bg-white flex flex-col items-center px-[40px] pt-[60px] pb-[60px] w-full z-10 shadow-[0px_1px_2px_-1px_rgba(0,0,0,0.1)]">
                            <div class="w-[80px] h-[80px] bg-[#e6f2ff] rounded-full flex items-center justify-center mb-[24px]">
                                <svg class="w-[40px] h-[40px] text-[#005bd3]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h2 class="text-[24px] font-bold text-[#141413] mb-[12px] font-sans">支付已完成</h2>
                            <p class="text-[16px] text-[#6a7282] text-center font-sans tracking-tight">
                                隨便塞的文字，支付成功的訊息可以在這裡顯示給使用者看，下次記得多買一點。
                            </p>
                        </div>
                    </div>
                    <div class="w-full bg-white flex flex-col p-[20px] shadow-form rounded-b-[12px] z-0">
                       <action-button 
                           text="完成" 
                           :primary="true" 
                           @click="$emit('done')"
                       ></action-button>
                    </div>
                </div>
            </div>
        `,
      });

      // --- Root App ---

      const RootComponent = defineComponent({
        components: {
          LoginStep,
          OtpStep,
          SelectCardStep,
          RegisterStep,
          LoadingOverlay,
          Toast,
          SuccessStep,
        },
        setup() {
          const currentStep = ref("LoginStep");
          const isLoading = ref(false);
          const loadingText = ref("處理中");
          const loadingSubtext = ref("");

          const cards = ref([]);
          const otpDestination = ref("");
          const identityType = ref("");
          const identityValue = ref("");

          const toasts = ref([]);

          const showToast = (message, type = "success") => {
            const id = Date.now() + Math.random();
            toasts.value.unshift({ id, message, type });
            setTimeout(() => {
              toasts.value = toasts.value.filter((t) => t.id !== id);
            }, 3000);
          };

          const safeAction = async (action, errorMsg = "系統錯誤") => {
            try {
              return await action();
            } catch (error) {
              console.error(error);
              showToast(`${errorMsg}: ${error.message || error}`, "error");
              throw error;
            } finally {
              hideLoading();
            }
          };

          const showLoading = (text, subtext = "") => {
            isLoading.value = true;
            loadingText.value = text;
            loadingSubtext.value = subtext;
          };
          const hideLoading = () => {
            isLoading.value = false;
          };

          // --- Mastercard SDK Wrappers ---
          const encryptCard = async (payload) => {
            const [month, year] = payload.expiry.split("/");
            return await mcCheckoutService.encryptCard({
              primaryAccountNumber: payload.cardNumber.replace(/\s/g, ""),
              panExpirationMonth: month,
              panExpirationYear: year,
              cardSecurityCode: payload.cvc,
            });
          };

          const checkoutCard = async (cardId, popup) => {
            return await mcCheckoutService.checkoutWithCard({
              srcDigitalCardId: cardId,
              windowRef: popup,
            });
          };

          const checkoutNewCard = async (encryptRes, rememberMe, popup) => {
            return await mcCheckoutService.checkoutWithNewCard({
              encryptedCard: encryptRes.encryptedCard,
              cardBrand: encryptRes.cardBrand,
              windowRef: popup,
              rememberMe,
            });
          };

          const openPopup = () => {
            const width = 480;
            const height = 700;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            return window.open(
              "",
              "mastercard_popup",
              `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes,status=yes`
            );
          };

          const handleLoginNext = async (payload) => {
            identityType.value = payload.type;
            identityValue.value = payload.value;

            await safeAction(async () => {
              showLoading("正在驗證身份...");
              const lookupRequest = { [payload.type]: payload.value };
              const lookupRes = await mcCheckoutService.idLookup(lookupRequest);

              if (lookupRes?.consumerPresent) {
                showLoading("正在發送驗證碼...");
                const initRes = await mcCheckoutService.initiateValidation();
                otpDestination.value =
                  initRes?.maskedValidationChannel || payload.value;
                currentStep.value = "OtpStep";
              } else {
                currentStep.value = "RegisterStep";
              }
            }, "驗證失敗").catch(() => {});
          };

          const handleOtpNext = async (otpCode) => {
            await safeAction(async () => {
              showLoading("正在驗證...", "請稍候");
              await mcCheckoutService.validate({ value: otpCode });
              const cardsRes = await mcCheckoutService.getCards();
              cards.value = cardsRes || [];
              currentStep.value = "SelectCardStep";
            }, "驗證失敗").catch(() => {});
          };

          const handlePayment = async (payload) => {
            const popup = openPopup();
            if (!popup) {
              showToast("無法開啟支付視窗，請檢查瀏覽器設定", "error");
              return;
            }

            await safeAction(async () => {
              showLoading("正在處理支付...");
              let checkoutRes;

              if (payload.isManual) {
                const encryptRes = await encryptCard(payload);
                checkoutRes = await checkoutNewCard(
                  encryptRes,
                  payload.rememberMe || false,
                  popup
                );
              } else {
                checkoutRes = await checkoutCard(payload.srcDigitalCardId, popup);
              }

              showToast("支付成功!");
              currentStep.value = "SuccessStep";
            }, "支付失敗")
              .finally(() => popup.close())
              .catch(() => {});
          };

          const handleRegisterNext = async (payload) => {
            // RegisterStep just collects manual data and initiates a checkout.
            await handlePayment({ ...payload, isManual: true });
          };

          const handleStepNext = (payload) => {
            if (currentStep.value === "LoginStep") {
              handleLoginNext(payload);
            } else if (currentStep.value === "RegisterStep") {
              handleRegisterNext(payload);
            } else if (currentStep.value === "OtpStep") {
              handleOtpNext(payload);
            }
          };

          const handlePrev = () => {
            if (currentStep.value === "RegisterStep") {
              currentStep.value = "LoginStep";
            } else if (currentStep.value === "OtpStep") {
              currentStep.value = "LoginStep";
            }
          };

          const debugSteps = [
            "LoginStep",
            "OtpStep",
            "SelectCardStep",
            "RegisterStep",
            "SuccessStep",
            "showToast"
          ];
          const setStep = (step) => {
            if (step === "SelectCardStep" && cards.value.length === 0) {
              cards.value = [
                {
                  srcDigitalCardId: "debug-1",
                  panBin: "541234",
                  panLastFour: "8888",
                  digitalCardData: { artUri: "public/ic_mastercard.svg" },
                },
              ];
            }
            if (step !== "showToast") {
            currentStep.value = step;
            } else {
              showToast("這是一個測試通知", "success");
            }
          };

          // Mastercard SDK Initialization
          onMounted(() => {
            if (mcCheckoutService) {
              console.log("Mastercard SDK detected, initializing...");
              mcCheckoutService
                .init({
                  srcDpaId: "4b03a667-6b18-467e-b046-e93c05e26176",
                  dpaData: {
                    dpaName: "DPA Name",
                  },
                  cardBrands: ["mastercard"],
                  dpaTransactionOptions: {
                    dpaLocale: "zh_HK",
                  },
                })
                .then(() => {
                  console.log("Mastercard SDK Initialized Successfully");
                })
                .catch((err) => {
                  console.error("Mastercard SDK Initialization Failed:", err);
                  // Since DPA_ID is a placeholder, this is expected to fail.
                });
            } else {
              console.warn("Mastercard SDK script not loaded or blocked.");
            }
          });

          return {
            currentStep,
            cards,
            otpDestination,
            isLoading,
            loadingText,
            loadingSubtext,
            toasts,
            handleStepNext,
            handlePrev,
            handlePayment,
            debugSteps,
            setStep,
          };
        },
        template: `
            <div class="relative w-full min-h-screen">
                <!-- Debug Controls -->
                <div class="fixed bottom-2 left-2 z-[9999] flex flex-col gap-1 bg-black/60 p-2 rounded text-[10px]">
                    <span class="text-white font-bold mb-1">Debug Steps:</span>
                    <button 
                        v-for="step in debugSteps" 
                        :key="step"
                        @click="setStep(step)"
                        class="px-2 py-1 rounded text-left"
                        :class="currentStep === step ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800 hover:bg-white'"
                    >
                        {{ step }}
                    </button>
                </div>

                <loading-overlay v-if="isLoading" :text="loadingText" :subtext="loadingSubtext"></loading-overlay>
                <toast :toasts="toasts"></toast>
                <transition name="fade" mode="out-in">
                    <component 
                        :is="currentStep" 
                        :cards="cards"
                        :otp-destination="otpDestination"
                        @next="handleStepNext"
                        @pay="handlePayment"
                        @prev="handlePrev"
                        @done="currentStep = 'LoginStep'"
                        @cancel="currentStep = 'LoginStep'"
                        @close="currentStep = 'LoginStep'"
                    ></component>
                </transition>
            </div>
        `,
      });

      createApp(RootComponent).mount("#app");
    </script>
  </body>
</html>
